<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGoChat 测试客户端</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            width: 90%;
            max-width: 1200px;
            height: 700px;
            display: flex;
        }

        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: #34495e;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #3a506b;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .chat-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fff;
        }

        .chat-input {
            background: white;
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #ecf0f1;
        }

        input, select, button, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .hidden {
            display: none !important;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .chat-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #3a506b;
            border-radius: 6px;
            background: #34495e;
        }

        .chat-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #3a506b;
            transition: background 0.2s;
        }

        .chat-item:hover {
            background: #3a506b;
        }

        .chat-item.active {
            background: #667eea;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.sent {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.received {
            background: #e9ecef;
            color: #333;
        }

        .message-info {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 5px;
        }

        .offline-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6c757d;
            margin-left: 5px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
        }

        .tab-btn.active {
            background: #667eea;
        }

        .form-section {
            background: #34495e;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        #messageInput {
            flex: 1;
            margin-right: 10px;
        }

        #sendButton {
            width: auto;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>MyGoChat</h2>
                <div id="userInfo" class="hidden">
                    <p>用户: <span id="currentUser"></span></p>
                    <span class="online-status"></span>在线
                </div>
            </div>

            <div class="sidebar-content">
                <!-- 登录/注册区域 -->
                <div id="authSection">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="showLogin()">登录</button>
                        <button class="tab-btn" onclick="showRegister()">注册</button>
                    </div>

                    <!-- 登录表单 -->
                    <div id="loginForm" class="form-section">
                        <div class="form-group">
                            <label>用户名:</label>
                            <input type="text" id="loginUsername" placeholder="请输入用户名">
                        </div>
                        <div class="form-group">
                            <label>密码:</label>
                            <input type="password" id="loginPassword" placeholder="请输入密码">
                        </div>
                        <button onclick="login()">登录</button>
                    </div>

                    <!-- 注册表单 -->
                    <div id="registerForm" class="form-section hidden">
                        <div class="form-group">
                            <label>用户名:</label>
                            <input type="text" id="registerUsername" placeholder="请输入用户名">
                        </div>
                        <div class="form-group">
                            <label>密码:</label>
                            <input type="password" id="registerPassword" placeholder="请输入密码">
                        </div>
                        <div class="form-group">
                            <label>昵称:</label>
                            <input type="text" id="registerNickname" placeholder="请输入昵称">
                        </div>
                        <button onclick="register()">注册</button>
                    </div>
                </div>

                <!-- 功能区域 -->
                <div id="functionsSection" class="hidden">
                    <!-- 创建群聊 -->
                    <div class="form-section">
                        <h4>创建群聊</h4>
                        <div class="form-group">
                            <input type="text" id="groupName" placeholder="请输入群聊名称">
                        </div>
                        <button onclick="createGroup()" class="btn-success">创建群聊</button>
                    </div>

                    <!-- 开始私聊 -->
                    <div class="form-section">
                        <h4>开始私聊</h4>
                        <div class="form-group">
                            <input type="text" id="targetUserUuid" placeholder="请输入对方用户UUID">
                        </div>
                        <button onclick="startPrivateChat()" class="btn-secondary">开始私聊</button>
                    </div>

                    <!-- 刷新按钮 -->
                    <button onclick="loadConversations()" class="btn-secondary">刷新聊天列表</button>
                </div>

                <!-- 聊天列表 -->
                <div id="chatListSection" class="hidden">
                    <h4>聊天列表</h4>
                    <div id="chatList" class="chat-list">
                        <!-- 聊天项目将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 主聊天区域 -->
        <div class="main-content">
            <div class="chat-header">
                <div>
                    <h3 id="chatTitle">选择一个聊天开始对话</h3>
                    <small id="chatSubtitle"></small>
                </div>
                <div>
                    <button onclick="syncOfflineMessages()" class="btn-secondary" id="syncButton" style="display: none;">同步离线消息</button>
                    <button onclick="logout()" class="btn-secondary" id="logoutButton" style="display: none;">退出登录</button>
                </div>
            </div>

            <div id="chatMessages" class="chat-messages">
                <div style="text-align: center; color: #6c757d; margin-top: 50px;">
                    <h4>欢迎使用 MyGoChat</h4>
                    <p>请先登录，然后选择一个聊天开始对话</p>
                </div>
            </div>

            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="输入消息..." disabled>
                <button id="sendButton" onclick="sendMessage()" disabled>发送</button>
            </div>
        </div>
    </div>

    <!-- 状态显示 -->
    <div id="statusMessage" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <script>
        // 全局变量
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let currentConversation = null;
        let websocket = null;
        let conversations = [];

        // API 基础 URL
        const API_BASE = 'http://localhost:8080/api';
        const WS_BASE = 'ws://localhost:8081/ws';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken && currentUser.uuid) {
                showLoggedInState();
                connectWebSocket();
                loadConversations();
            }
        });

        // 显示状态消息
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // 切换登录/注册表单
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 注册
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const nickname = document.getElementById('registerNickname').value;

            if (!username || !password || !nickname) {
                showStatus('请填写所有字段', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/user/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        nickname: nickname
                    })
                });

                const data = await response.json();
                if (data.code === 0) {
                    showStatus('注册成功！请登录');
                    showLogin();
                    // 清空注册表单
                    document.getElementById('registerUsername').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerNickname').value = '';
                } else {
                    showStatus(data.msg || '注册失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误: ' + error.message, 'error');
            }
        }

        // 登录
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showStatus('请填写用户名和密码', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/user/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                if (data.code === 0) {
                    authToken = data.data.token;
                    currentUser = data.data.user;

                    // 保存到本地存储
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    showStatus('登录成功！');
                    showLoggedInState();
                    connectWebSocket();
                    loadConversations();
                } else {
                    showStatus(data.msg || '登录失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误: ' + error.message, 'error');
            }
        }

        // 显示已登录状态
        function showLoggedInState() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('functionsSection').classList.remove('hidden');
            document.getElementById('chatListSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('syncButton').style.display = 'inline-block';
            document.getElementById('logoutButton').style.display = 'inline-block';

            document.getElementById('currentUser').textContent = currentUser.nickname || currentUser.username;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
        }

        // 退出登录
        function logout() {
            authToken = null;
            currentUser = {};
            currentConversation = null;

            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');

            if (websocket) {
                websocket.close();
                websocket = null;
            }

            // 重置界面
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('functionsSection').classList.add('hidden');
            document.getElementById('chatListSection').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('syncButton').style.display = 'none';
            document.getElementById('logoutButton').style.display = 'none';

            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('chatMessages').innerHTML = `
                <div style="text-align: center; color: #6c757d; margin-top: 50px;">
                    <h4>欢迎使用 MyGoChat</h4>
                    <p>请先登录，然后选择一个聊天开始对话</p>
                </div>
            `;
            document.getElementById('chatTitle').textContent = '选择一个聊天开始对话';
            document.getElementById('chatSubtitle').textContent = '';

            showStatus('已退出登录');
        }

        // WebSocket 连接
        function connectWebSocket() {
            if (!authToken) return;

            try {
                websocket = new WebSocket(`${WS_BASE}?token=${authToken}`);

                websocket.onopen = function() {
                    showStatus('WebSocket 连接成功');
                    console.log('WebSocket connected');
                };

                websocket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleIncomingMessage(message);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                };

                websocket.onclose = function() {
                    showStatus('WebSocket 连接已断开', 'error');
                    console.log('WebSocket disconnected');

                    // 尝试重连
                    setTimeout(() => {
                        if (authToken) {
                            connectWebSocket();
                        }
                    }, 3000);
                };

                websocket.onerror = function(error) {
                    showStatus('WebSocket 连接错误', 'error');
                    console.error('WebSocket error:', error);
                };

            } catch (error) {
                showStatus('WebSocket 连接失败: ' + error.message, 'error');
            }
        }

        // 处理收到的消息
        function handleIncomingMessage(message) {
            console.log('Received message:', message);

            // 如果是当前对话的消息，显示在聊天区域
            if (currentConversation && message.conversationID === currentConversation.id) {
                displayMessage(message, false);
            }

            // 更新会话列表（显示最新消息）
            updateConversationInList(message);
        }

        // 创建群聊
        async function createGroup() {
            const groupName = document.getElementById('groupName').value;
            if (!groupName) {
                showStatus('请输入群聊名称', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/group/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        group_name: groupName
                    })
                });

                const data = await response.json();
                if (data.code === 0) {
                    showStatus('群聊创建成功！');
                    document.getElementById('groupName').value = '';
                    loadConversations(); // 刷新聊天列表
                } else {
                    showStatus(data.msg || '创建群聊失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误: ' + error.message, 'error');
            }
        }

        // 开始私聊
        async function startPrivateChat() {
            const targetUserUuid = document.getElementById('targetUserUuid').value;
            if (!targetUserUuid) {
                showStatus('请输入对方用户UUID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/conversation/private`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        target_user_uuid: targetUserUuid
                    })
                });

                const data = await response.json();
                if (data.code === 0) {
                    showStatus('私聊会话创建成功！');
                    document.getElementById('targetUserUuid').value = '';
                    loadConversations(); // 刷新聊天列表
                } else {
                    showStatus(data.msg || '创建私聊失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误: ' + error.message, 'error');
            }
        }

        // 加载聊天列表
        async function loadConversations() {
            if (!authToken) return;

            try {
                const response = await fetch(`${API_BASE}/conversation/list`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (data.code === 0) {
                    conversations = data.data.conversations || [];
                    displayConversations();
                } else {
                    showStatus(data.msg || '获取聊天列表失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误: ' + error.message, 'error');
            }
        }

        // 显示聊天列表
        function displayConversations() {
            const chatList = document.getElementById('chatList');
            if (conversations.length === 0) {
                chatList.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;">暂无聊天记录</div>';
                return;
            }

            chatList.innerHTML = conversations.map(conv => `
                <div class="chat-item" onclick="selectConversation('${conv.id}')">
                    <div style="font-weight: 500;">${conv.name || '未命名聊天'}</div>
                    <div style="font-size: 12px; color: #bdc3c7; margin-top: 4px;">
                        ${conv.lastMessage || '暂无消息'}
                    </div>
                    <div style="font-size: 11px; color: #95a5a6; margin-top: 4px;">
                        ${conv.type === 1 ? '私聊' : '群聊'} • ${formatTime(conv.lastMessageTimestamp)}
                    </div>
                </div>
            `).join('');
        }

        // 选择会话
        async function selectConversation(conversationId) {
            // 移除之前的选中状态
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });

            // 添加当前选中状态
            event.currentTarget.classList.add('active');

            // 设置当前会话
            currentConversation = conversations.find(conv => conv.id === conversationId);
            if (!currentConversation) return;

            // 更新聊天标题
            document.getElementById('chatTitle').textContent = currentConversation.name || '聊天';
            document.getElementById('chatSubtitle').textContent =
                `${currentConversation.type === 1 ? '私聊' : '群聊'} • ID: ${conversationId}`;

            // 清空聊天消息
            document.getElementById('chatMessages').innerHTML = '';

            // 加载历史消息
            await loadMessageHistory(conversationId);
        }

        // 加载消息历史
        async function loadMessageHistory(conversationId) {
            try {
                const response = await fetch(`${API_BASE}/message/history/${conversationId}?limit=50&offset=0`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (data.code === 0) {
                    const messages = data.data.messages || [];
                    messages.forEach(message => {
                        displayMessage(message, message.senderUUID === currentUser.uuid);
                    });
                } else {
                    showStatus(data.msg || '获取消息历史失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误: ' + error.message, 'error');
            }
        }

        // 显示消息
        function displayMessage(message, isSent) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

            let content = '';
            if (typeof message.body === 'string') {
                content = message.body;
            } else if (message.body && message.body.content) {
                content = message.body.content;
            } else {
                content = '[消息内容解析失败]';
            }

            messageDiv.innerHTML = `
                <div>${content}</div>
                <div class="message-info">
                    ${isSent ? '我' : (message.senderName || '对方')} • ${formatTime(message.sendAt || Date.now())}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 发送消息
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (!messageText || !currentConversation || !websocket) {
                showStatus('请选择聊天对象或检查连接状态', 'error');
                return;
            }

            const message = {
                conversationID: currentConversation.id,
                contentType: 1, // 文本消息
                body: {
                    content: messageText
                },
                messageType: currentConversation.type, // 1=私聊，2=群聊
                recipientUUID: currentConversation.recipientUUID || '', // 私聊时需要
                sendAt: Date.now()
            };

            try {
                websocket.send(JSON.stringify(message));

                // 显示发送的消息
                displayMessage({
                    body: messageText,
                    sendAt: Date.now(),
                    senderUUID: currentUser.uuid
                }, true);

                messageInput.value = '';
            } catch (error) {
                showStatus('发送消息失败: ' + error.message, 'error');
            }
        }

        // 同步离线消息
        async function syncOfflineMessages() {
            try {
                const response = await fetch(`${API_BASE}/message/sync-offline`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (data.code === 0) {
                    showStatus('离线消息同步成功');
                } else {
                    showStatus(data.msg || '同步离线消息失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误: ' + error.message, 'error');
            }
        }

        // 更新会话列表中的消息
        function updateConversationInList(message) {
            const conv = conversations.find(c => c.id === message.conversationID);
            if (conv) {
                conv.lastMessage = typeof message.body === 'string' ? message.body : message.body?.content || '[消息]';
                conv.lastMessageTimestamp = message.sendAt;
                displayConversations(); // 重新渲染列表
            }
        }

        // 格式化时间
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(typeof timestamp === 'string' ? parseInt(timestamp) * 1000 : timestamp);
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 回车发送消息
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
