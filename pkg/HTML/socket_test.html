<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/google-protobuf@3.20.1/google-protobuf.js"></script>
    <script src="message_pb.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        .container { border: 1px solid #ccc; padding: 20px; margin-top: 20px; border-radius: 8px; width: 600px; }
        input { margin-bottom: 10px; padding: 8px; width: 95%; }
        button { padding: 10px 15px; cursor: pointer; }
        #log { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; background: #f9f9f9; margin-top: 10px; }
        h1, h2 { text-align: center; }
    </style>
</head>
<body>

    <h1>WebSocket Test (Protobuf)</h1>

    <div class="container">
        <h2>1. Login</h2>
        <form onsubmit="return false;">
            <p>Username: <input type="text" id="username" value="hawa130"></p>
            <p>Password: <input type="password" id="password" value="114514"></p>
            <button onclick="login()">Login</button>
        </form>
        <p><b>JWT Token:</b> <span id="token" style="display:inline-block; max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle;"></span></p>
    </div>

    <div class="container">
        <h2>2. WebSocket Connection</h2>
        <button id="connectBtn" onclick="connect()" disabled>Connect</button>
        <hr>
        <p>Recipient ID: <input type="text" id="recipientId" value="2"></p>
        <p>Message: <input type="text" id="message" size="50"></p>
        <button onclick="sendMessage()">Send (Protobuf)</button>
        <h2>Log:</h2>
        <pre id="log"></pre>
    </div>

<script>
    let ws;
    let jwtToken;
    const logDiv = document.getElementById('log');
    const tokenSpan = document.getElementById('token');
    const connectBtn = document.getElementById('connectBtn');

    function log(message) {
        logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function login() {
        log('INFO: login function called.');
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;


        try {
            const response = await fetch('http://localhost:8080/api/user/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });
            log(`INFO: Login request sent. Status: ${response.status}`);
            const data = await response.json();

            if (response.ok && data.data && data.data.token) {
                jwtToken = data.data.token;
                tokenSpan.textContent = jwtToken;
                log('INFO: Login successful. Token received.');
                connectBtn.disabled = false;
            } else {
                const errorMsg = data.msg || 'Login failed';
                log(`ERROR: ${errorMsg}`);
                tokenSpan.textContent = 'Login Failed!';
            }
        } catch (error) {
            log('FATAL: Error during login fetch.');
            log('ERROR: ' + error);
        }
    }

    function connect() {
        log('INFO: connect function called.');
        if (!jwtToken) {
            log('ERROR: Cannot connect without JWT token.');
            alert('Please login first to get a JWT token.');
            return;
        }
        const url = `ws://localhost:8080/ws?token=${jwtToken}`;
        log(`INFO: Connecting to ${url}`);
        ws = new WebSocket(url);
        ws.binaryType = 'arraybuffer';

        ws.onopen = function(event) {
            log(`INFO: Connection opened. WebSocket readyState: ${ws.readyState}`);
        };

        ws.onmessage = function(event) {
            log(`INFO: onmessage event fired. Received ${event.data.byteLength} bytes.`);
            try {
                const msg = proto.v1.Message.deserializeBinary(event.data);
                const msgObject = msg.toObject();
                log('RECV: ' + JSON.stringify(msgObject, null, 2));
            } catch (e) {
                log('FATAL: Error deserializing message.');
                log('ERROR: ' + e.message);
                console.error('Deserialization error:', e);
            }
        };

        ws.onclose = function(event) {
            log(`INFO: Connection closed. Code: ${event.code}, Reason: ${event.reason}`);
            ws = null;
        };

        ws.onerror = function(event) {
            log('ERROR: WebSocket error occurred.');
            console.error('WebSocket error:', event);
        };
    }

    function sendMessage() {
        log('INFO: sendMessage function called.');
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            log('ERROR: WebSocket not connected or not open.');
            alert('Not connected. Please connect first.');
            return;
        }
        try {

            const recipientId = parseInt(document.getElementById('recipientId').value, 10);
            const content = document.getElementById('message').value;
            log(`INFO: Preparing to send message to recipient ${recipientId}.`);

            const msg = new proto.v1.Message();
            log('INFO: Protobuf message object created successfully.');

            msg.setSenderid(1); // Set a dummy sender ID
            msg.setRecipientid(recipientId); // This sets recipientId
            msg.setContent(content);
            msg.setMessagetype(1); // 1 for single chat
            msg.setContenttype(1);  // 1 for text message
            log('INFO: Message fields set.');

            const payload = msg.serializeBinary();
            log(`INFO: Message serialized to ${payload.length} bytes.`);
            
            ws.send(payload);
            log('SENT: [Protobuf binary data]');
            document.getElementById('message').value = '';
        } catch (e) {
            log('FATAL: An error occurred in sendMessage. This might mean the protobuf scripts failed to load.');
            log('ERROR: ' + e.message);
            console.error('sendMessage error:', e);
        }
    }
</script>
</body>
</html>
