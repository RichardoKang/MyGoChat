<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        .container { border: 1px solid #ccc; padding: 20px; margin-top: 20px; border-radius: 8px; width: 600px; }
        input { margin-bottom: 10px; padding: 8px; width: 95%; }
        button { padding: 10px 15px; cursor: pointer; }
        #log { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; background: #f9f9f9; margin-top: 10px; }
        h1, h2 { text-align: center; }
    </style>
</head>
<body>

    <h1>WebSocket Test</h1>

    <div class="container">
        <h2>1. Login</h2>
        <p>Username: <input type="text" id="username" value="hawa130"></p>
        <p>Password: <input type="password" id="password" value="114514"></p>
        <button onclick="login()">Login</button>
        <p><b>JWT Token:</b> <span id="token" style="display:inline-block; max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle;"></span></p>
    </div>

    <div class="container">
        <h2>2. WebSocket Connection</h2>
        <button id="connectBtn" onclick="connect()" disabled>Connect</button>
        <hr>
        <p>Recipient ID: <input type="number" id="recipientId" value="2"></p>
        <p>Message: <input type="text" id="message" size="50"></p>
        <button onclick="sendMessage()">Send</button>
        <h2>Log:</h2>
        <pre id="log"></pre>
    </div>

<script>
    let ws;
    let jwtToken;
    const logDiv = document.getElementById('log');
    const tokenSpan = document.getElementById('token');
    const connectBtn = document.getElementById('connectBtn');

    function log(message) {
        logDiv.innerHTML += message + '\n';
    }

    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('http://localhost:8080/api/user/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok && data.data && data.data.token) {
                jwtToken = data.data.token;
                tokenSpan.textContent = jwtToken;
                log('INFO: Login successful. Token received.');
                connectBtn.disabled = false;
            } else {
                const errorMsg = data.msg || 'Login failed';
                log(`ERROR: ${errorMsg}`);
                tokenSpan.textContent = 'Login Failed!';
            }
        } catch (error) {
            log('ERROR: ' + error);
        }
    }

    function connect() {
        if (!jwtToken) {
            alert('Please login first to get a JWT token.');
            return;
        }
        const url = `ws://localhost:8080/ws?token=${jwtToken}`;
        ws = new WebSocket(url);

        ws.onopen = function(event) {
            log(`INFO: Connected to WebSocket server.`);
        };

        ws.onmessage = function(event) {
            try {
                const msg = JSON.parse(event.data);
                log('RECV: ' + JSON.stringify(msg, null, 2));
            } catch (e) {
                log('RECV (raw): ' + event.data);
            }
        };

        ws.onclose = function(event) {
            log('INFO: Connection closed.');
            ws = null;
        };

        ws.onerror = function(event) {
            log('ERROR: WebSocket error.');
            console.error('WebSocket error:', event);
        };
    }

    function sendMessage() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('Not connected. Please connect first.');
            return;
        }
        const recipientId = parseInt(document.getElementById('recipientId').value, 10);
        const content = document.getElementById('message').value;

        const msg = {
            recipientId: recipientId,
            content: content,
            messageType: 1, // 1 for single chat
            contentType: 1  // 1 for text message
        };

        const payload = JSON.stringify(msg);
        ws.send(payload);
        log('SENT: ' + payload);
        document.getElementById('message').value = '';
    }
</script>
</body>
</html>
